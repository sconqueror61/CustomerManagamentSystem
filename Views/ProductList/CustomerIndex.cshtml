@{
    var products = ViewBag.Products as List<CustomerManagementSystem.DB.Product>;
}

@{
    Layout = null;
    ViewData["Title"] = "CustomerIndex";
}

<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="utf-8" />
    <title>@ViewData["Title"] - CustomerProductsList</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Bootstrap & FontAwesome -->
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/CustomerManagementSystem.styles.css" asp-append-version="true" />
    <link href="~/lib/font-awesome/all.min.css" rel="stylesheet" />
    <script src="~/lib/font-awesome/all.min.js"></script>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-primary">
        <div class="container-fluid d-flex justify-content-between align-items-center">

            <!-- Sol: Logo ve Menü -->
            <div class="d-flex align-items-center">
                <a class="navbar-brand text-white me-3" href="#">CMS</a>
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link text-white" asp-area="" asp-controller="CustomerHome" asp-action="Index">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white" asp-area="" asp-controller="ProductList" asp-action="CustomerIndex">Products</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white" href="#">İletişim</a>
                    </li>
                </ul>
            </div>

            <!-- Orta: Search tam ortada -->
            <form class="d-flex mx-auto" style="width: 100%; max-width: 400px; justify-content: center;">
                <input class="form-control me-2" type="search" placeholder="Search" aria-label="Search"
                       style="height: 30px; font-size: 14px; width: 70%;">
                <button class="btn btn-success" type="submit" style="height: 30px; font-size: 14px;">
                    <i class="fa-solid fa-magnifying-glass"></i>
                </button>
            </form>

            <!-- Sağ: LogOut -->
            <div class="d-flex">
                <a class="btn btn-danger" asp-area="" asp-controller="Starting" asp-action="LogOut"
                   style="height: 30px; font-size: 14px;">
                    <i class="fa-solid fa-right-from-bracket"></i> LogOut
                </a>
            </div>

        </div>
    </nav>

    <div class="d-flex flex-column justify-content-center align-items-center min-vh-30">
        <div class="d-flex align-items-center mt-3">
            <div class="btn-group me-3" role="group" id="buttonContainer">
                <!-- Dinamik butonlar buraya eklenecek -->
            </div>

            <div class="d-flex gap-2">
                <button class="btn btn-outline-secondary" id="highFilter">
                    <i class="fa-solid fa-arrow-up"></i> Up $
                </button>
                <button class="btn btn-outline-secondary" id="lowFilter">
                    <i class="fa-solid fa-arrow-down"></i> Down $
                </button>
            </div>
        </div>

        <div class="container mt-5">
            <div id="productContainer" class="row g-3 justify-content-center">
                <!-- Ürünler buraya gelecek -->
            </div>
        </div>
    </div>


    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>

        $(document).ready(function () {
            // Kategori butonlarını yükleme
            $.ajax({
                url: "/Pcategories/GetCategoryByIds",
                type: "GET",
                dataType: "json",
                success: function (catResponse) {
                    var buttonContainer = $("#buttonContainer");
                    buttonContainer.empty();

                    catResponse.forEach(function (category) {
                        console.log(category)
                        var button = $("<button>")
                            .addClass("btn btn-outline-primary filter-btn")
                            .attr("data-id", category.id)
                            .text(category.categories)
                            .on("click", function () {
                                $(".filter-btn").removeClass("btn-primary").addClass("btn-outline-primary");
                                $(this).removeClass("btn-outline-primary").addClass("btn-primary");
                            })
                            .appendTo("#buttonContainer");
                    });
                },
                error: function (xhr, status, error) {
                    console.error("AJAX hatası:", error);
                    $("#buttonContainer").text("Kategoriler yüklenemedi");
                }
            });

        });

        $(document).ready(function () {
        let currentSortOrder = "asc";

         function loadProducts(selectedCategoryId = null, sortOrder = "asc") {
             $.ajax({
                 url: "/ProductList/GetAllProducts",
                 type: "GET",
                 data: { categoryId: selectedCategoryId },
                 dataType: "json",
                 success: function (response) {
                     if (!response.success) {
                         $("#productContainer").html(`<p class="text-danger text-center">${response.message}</p>`);
                         return;
                     }

                     let data = response.data;

                     if (selectedCategoryId) {
                         data = data.filter(item => item.categoryId == selectedCategoryId);
                     }

                     // **Fiyat sıralaması**
                     data.sort((a, b) => {
                         return sortOrder === "asc" ? a.price - b.price : b.price - a.price;
                     });

                     let productHtml = "";
                     if (data && data.length > 0) {
                         data.forEach(item => {
                             let firstImage = item.pimages?.length > 0 ? item.pimages[0] : "/images/no-image.png";

                             productHtml += `
                                 <div class="col-md-4 mb-4">
                                     <div class="card" style="max-width: 18rem; max-height: 400px; overflow: hidden;">
                                         <div class="d-flex justify-content-center">
                                             <img src="${firstImage}" class="img-fluid mb-3 img-thumbnail" style="max-height: 200px; object-fit: cover;">
                                         </div>
                                         <div class="card-body">
                                             <h5 class="card-title text-truncate" style="max-width: 100%;">
                                                 <span>Brand:</span> ${item.explanation}
                                             </h5>
                                             <h6 class="card-subtitle mb-2 text-muted">
                                                 <span>Description:</span> ${item.description}
                                             </h6>
                                             <h5 class="card-text text-truncate" style="max-height: 100px; overflow: hidden;">
                                                 <span>Price:</span> ${item.price}$                                              
                                             </h5>
                                         </div>
                                     </div>
                                 </div>`;
                         });
                     } else {
                         productHtml = `<p class="text-center">No products available.</p>`;
                     }

                     $("#productContainer").html(productHtml);
                 },
                 error: function () {
                     $("#productContainer").html(`<p class="text-danger text-center">Failed to load products.</p>`);
                 }
             });
         }

         // Sayfa yüklendiğinde ürünleri varsayılan olarak yükle
         loadProducts();

         // **Sıralama butonları için event listener**
         $("#highFilter").click(function () {
             currentSortOrder = "desc";
             loadProducts(null, "desc");
         });

         $("#lowFilter").click(function () {
             currentSortOrder = "asc";
             loadProducts(null, "asc");
         });
            // Filtre butonlarına tıklanınca ürünleri güncelle
            $(document).on("click", ".filter-btn", function () {
                let selectedCategoryId = $(this).attr("data-id");
                loadProducts(selectedCategoryId);
            });
        });

             function Get(itemId) {
                $.ajax({
                    url: '/ProductList/GetProduct',
                    type: 'GET',
                    data: {itemId},
                    success: function (data) {
                        $('#explanationE').val("Explanation="+data.explanation);
                        $('#descriptionE').val("Description="+data.description);
                        $('#widthE').val("Width="+data.width);
                        $('#heightE').val("Height="+data.height);
                        $('#priceE').val("Price="+data.price);
                        $('#breakibilityE').val("Breakibility="+data.breakibility);
                    },
                    error: function (xhr, status, error) {
                        console.error("Ürün bilgileri alınamadı: " + error + itemId);
                    }
                });
            }

    </script>


    <footer class="footer bg-light text-center py-3">
        <div class="container">
            <span class="text-muted">&copy; @DateTime.Now.Year - Customer Management System</span>
        </div>
    </footer>
</body>
</html>
