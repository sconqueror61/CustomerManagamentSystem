@{
    var products = ViewBag.Products as List<CustomerManagementSystem.DB.Product>;
}

@{
    ViewData["Title"] = "ProductList";
}

<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="utf-8" />
    <title>@ViewData["Title"] - ProductsList</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        .product-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

       .product-card:hover {
           transform: scale(1.02);
           box-shadow: 0 0 10px rgba(0,0,0,0.2);
           cursor: pointer;
       }
    </style>

</head>

<body>
    <div class="d-flex justify-content-between align-items-center mt-3 flex-wrap">
        <!-- Sol: Kategori ve sıralama butonları -->
        <div class="d-flex flex-wrap gap-3 flex-column flex-md-row align-items-center">
            <!-- Kategori butonları -->
            <div class="d-flex flex-wrap gap-2 justify-content-center" role="group" id="buttonContainer">
                <!-- Dinamik butonlar buraya eklenecek -->
            </div>

            <!-- Sıralama butonları -->
            <div class="d-flex gap-2 justify-content-center">
                <button class="btn btn-outline-secondary" id="highFilter">
                    <i class="fa-solid fa-arrow-up"></i> Up $
                </button>
                <button class="btn btn-outline-secondary" id="lowFilter">
                    <i class="fa-solid fa-arrow-down"></i> Down $
                </button>
            </div>
        </div>

        <!-- Sağ: Add butonu -->
        <div class="mt-3 mt-md-0">
            <a id="AddnewProduct" class="btn btn-success" asp-controller="Product" asp-action="Index">
                <i class="fa-solid fa-plus"></i> Add
            </a>
        </div>
    </div>

    <div class="container mt-5">
        <div id="productContainer" class="row g-3 justify-content-center">
            <!-- Ürünler buraya gelecek -->
        </div>
    </div>

    <!--Ana Modal-->
    <div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="modalTitle" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <!-- Modal Header -->
                <div class="modal-header d-flex justify-content-between align-items-center bg-primary text-white">
                    <div class="d-flex align-items-center w-100">
                        <h5 class="modal-title mb-0 me-1" id="modalTitle"></h5>
                        <h5 id="modalDescription" class="text-warning mb-0"></h5>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <!-- Modal Body -->
                <div class="modal-body text-center bg-light">
                    <img id="modalImage" src="" class="img-fluid mb-3 img-thumbnail" style="max-height: 200px; object-fit: cover;">
                    <h5 id="modalBreakibility" class="text-dark"></h5>
                    <h5 id="modalCategoryid" class="text-dark"></h5>
                    <h5 id="modalStock" class="text-dark"></h5>
                    <h5 id="modalWidth" class="text-dark"></h5>
                    <h5 id="modalHeight" class="text-dark"></h5>
                    <h5 id="modalPrice" class="text-success mb-0"></h5>
                </div>

                <!-- Modal Footer -->
                <div class="modal-footer d-flex justify-content-between align-items-center bg-primary text-white">
                    <span id="productId" data-id=""></span>
                    <div class="btn-group" role="group" aria-label="Basic outlined example">
                        <button id="modalEditB" type="button" class="btn btn-warning"><i class="fa-solid fa-wrench me-1"></i>Edit</button>
                        <button id="modalDeleteB" type="button" class="btn btn-danger"><i class="fa-solid fa-trash-can me-1"></i>Delete</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!--EditModal -->
    <div id="editModal" class="modal fade" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog ">
            <div class="modal-content">
                <div class="modal-header  bg-warning">
                    <h5 class="modal-title"><i class="fa-solid fa-wrench me-1"></i>Edit</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="container">
                        <div class="row justify-content-center">
                            <div class="col-12">
                                <div class="d-flex align-items-center mb-3">
                                    <label for="explanationE" class="me-2" style="width: 120px;">Product:</label>
                                    <input id="explanationE" type="text" class="form-control">
                                </div>
                                <div class="d-flex align-items-center mb-3">
                                    <label for="descriptionE" class="me-2" style="width: 120px;">Description:</label>
                                    <input id="descriptionE" type="text" class="form-control">
                                </div>
                                <div class="d-flex align-items-center mb-3">
                                    <label for="breakibilityE" class="me-2" style="width: 120px;">Breakibility:</label>
                                    <input id="breakibilityE" type="radio" name="breakibility" class="form-check-input">
                                </div>
                                <div class="d-flex align-items-center mb-3">
                                    <label for="categorySelect" class="me-2" style="width: 120px;">Category:</label>
                                    <select id="categorySelect" class="form-control">
                                        <option disabled selected value="">Select a Category</option>
                                    </select>
                                </div>
                                <div class="d-flex align-items-center mb-3">
                                    <label for="widthE" class="me-2" style="width: 120px;">Width:</label>
                                    <input id="widthE" type="text" class="form-control">
                                </div>
                                <div class="d-flex align-items-center mb-3">
                                    <label for="heightE" class="me-2" style="width: 120px;">Height:</label>
                                    <input id="heightE" type="text" class="form-control">
                                </div>
                                <div class="d-flex align-items-center mb-3">
                                    <label for="priceE" class="me-2" style="width: 120px;">Price:</label>
                                    <input id="priceE" type="text" class="form-control">
                                </div>

                                <div class="d-flex align-items-center mb-3">
                                    <label for="stockE" class="me-2" style="width: 120px;">Stocked:</label>
                                    <input id="stockE" type="text" class="form-control">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer  bg-warning">
                    <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
                    <button id="submitB" type="button" class="btn btn-primary">Submit</button>
                </div>
            </div>
        </div>
    </div>


    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
            let selectedCategoryId = null;
            let currentSortOrder = null;

            $(document).ready(function () {

            // Breakibility çift tıklaması
            $("#breakibilityE").on("dblclick", function () {
                this.checked = !this.checked;
            });


            $.get("/Pcategories/GetCategoryByIds", function (catResponse) {
            let buttonContainer = $("#buttonContainer");
            buttonContainer.empty();

            const categories = catResponse.data || catResponse; // hem doğrudan array gelirse hem object içinden data gelirse çalışır

            console.log("Kategori verisi:", categories);

            categories.forEach(function (category) {
                $("<button>")
                    .addClass("btn btn-outline-primary filter-btn")
                    .attr("data-id", category.id)
                    .text(category.categories)
                    .appendTo(buttonContainer);
                });
            });

            // Kategori selecti doldur
             $.get('/Pcategories/GetCategoryByIds', function (response) {
            let select = $('#categorySelect');
            select.empty().append('<option disabled selected value="">Select a Category</option>');
            console.log("response", response)
            $.each(response.data, function (index, item) {
                console.log(item,"asd")
                        select.append(`<option value="${item.id}">${item.categories}</option>`);
            });
               });

            function loadProducts() {
            $.ajax({
                url: "/ProductList/GetAllProducts",
                type: "GET",
                data: { categoryId: selectedCategoryId },
                dataType: "json",
                success: function (response) {
                    if (!response.success) {
                        $("#productContainer").html(`<p class="text-danger text-center">${response.message}</p>`);
                        return;
                    }
                    console.log(response)
                    let data = response.data || [];                        

                    // Fiyat sıralaması (opsiyonel)
                    if (data.length > 0 && typeof currentSortOrder !== "undefined") {
                        data.sort((a, b) => currentSortOrder === "asc" ? a.price - b.price : b.price - a.price);
                    }

                    let productHtml = data.map(item => {
                    let firstImage = (item.pimages && item.pimages.length > 0) ? item.pimages[0] : "/images/no-image.png";

                    return `
                        <div class="col-md-4 mb-4">
                            <div class="card product-card"
                                 style="max-width: 18rem; max-height: 400px; overflow: hidden; cursor: pointer;"
                                 data-bs-toggle="modal"
                                 data-bs-target="#productModal"
                                 data-id="${item.id}"
                                 data-title="${item.explanation}"
                                 data-description="${item.description}"
                                 data-price="${item.price}"
                                 data-categoryid="${item.categoryId}"
                                 data-width="${item.width}"
                                 data-height="${item.height}"
                                 data-image="${firstImage}"
                                 data-stock="${item.stock}"
                                 data-breakibility="${item.breakibility}">

                                <div class="d-flex justify-content-center">
                                    <img src="${firstImage}" class="img-fluid mb-3 img-thumbnail" style="max-height: 200px; object-fit: cover;">
                                </div>
                                <div class="card-body">
                                    <h5 class="card-title text-truncate"> ${item.explanation}</h5>
                                    <h6 class="card-subtitle mb-2 text-muted"> ${item.description}</h6>
                                    <h5 class="card-text">
                                        ${item.price}$
                                    </h5>
                                </div>
                            </div>
                        </div>`;
                }).join('');


                    $("#productContainer").html(productHtml || `<p class="text-center">No products available.</p>`);
                },
                error: function () {
                    $("#productContainer").html(`<p class="text-danger text-center">Failed to load products.</p>`);
                }
            });
        }

        loadProducts();

        $("#highFilter").click(function () {
            const isActive = $(this).hasClass("btn-secondary");

            // Tıklama zaten aktifse pasif hale getir
            if (isActive) {
                $(this).removeClass("btn-secondary").addClass("btn-outline-secondary");
                currentSortOrder = null;
            } else {
                $("#lowFilter").removeClass("btn-secondary").addClass("btn-outline-secondary"); // Diğer butonu sıfırla
                $(this).removeClass("btn-outline-secondary").addClass("btn-secondary");
                currentSortOrder = "desc";
            }

            loadProducts();
        });

        $("#lowFilter").click(function () {
            const isActive = $(this).hasClass("btn-secondary");

            if (isActive) {
                $(this).removeClass("btn-secondary").addClass("btn-outline-secondary");
                currentSortOrder = null;
            } else {
                $("#highFilter").removeClass("btn-secondary").addClass("btn-outline-secondary"); // Diğer butonu sıfırla
                $(this).removeClass("btn-outline-secondary").addClass("btn-secondary");
                currentSortOrder = "asc";
            }

            loadProducts();
        });


        // Kategori filtreleme
        $(document).on("click", ".filter-btn", function () {
            let clickedId = parseInt($(this).attr("data-id"));
            if (selectedCategoryId === clickedId) {
                selectedCategoryId = null;
                $(".filter-btn").removeClass("btn-primary").addClass("btn-outline-primary");
            } else {
                selectedCategoryId = clickedId;
                $(".filter-btn").removeClass("btn-primary").addClass("btn-outline-primary");
                $(this).removeClass("btn-outline-primary").addClass("btn-primary");
            }
            loadProducts();
        });

            // Silme
            $("#modalDeleteB").click(function () {
                let id = $("#productId").data("id");
                $.ajax({
                    url: '/ProductList/Delete/' + id,
                    type: 'DELETE',
                    success: function (res) {
                        if (res.success) {
                            $('#productModal').modal('hide');
                            alert("Product deleted successfully!");
                            location.reload();
                        } else {
                            alert("Error: " + res.message);
                        }
                    },
                    error: function () {
                        alert("An error occurred.");
                    }
                });
            });

        });

        $(document).on("click", ".product-card", function () {
            const card = $(this);
            const productId = card.data("id");
            $("#productId").attr("data-id", productId);

            // Verileri kontrol ederek modal alanlarına yaz
            const title = card.data("title") ?? "Undefined";
            const description = card.data("description") ?? "Undefined";
            const price = card.data("price") != null ? `Price: $${card.data("price")}` : "Undefined";
            const image = card.data("image") || "/images/no-image.png";
            const breakibility = card.data("breakibility") ? "Breakibility: Yes" : "Breakibility: No";
            const categoryId = card.data("categoryid") ?? "Undefined";
            const stock = card.data("stock") != null ? `Stock: ${card.data("stock")}` : "Undefined";
            const width = card.data("width") != null ? `Width: ${card.data("width")}m` : "Undefined";
            const height = card.data("height") != null ? `Height: ${card.data("height")}m` : "Undefined";

            // Modal'a yerleştir
            $("#modalTitle").text(title);
            $("#modalDescription").text(description);
            $("#modalPrice").text(price);
            $("#modalImage").attr("src", image);
            $("#modalBreakibility").text(breakibility);
            $("#modalCategoryid").text(categoryId);
            $("#modalStock").text(stock);
            $("#modalWidth").text(width);
            $("#modalHeight").text(height);
        });

        $(document).on("click", "#modalEditB", function () {
            // Clear modal input fields before populating them with the current product's data
            $("#explanationE").val('');
            $("#descriptionE").val('');
            $("#widthE").val('');
            $("#heightE").val('');
            $("#priceE").val('');
            $("#breakibilityE").prop("checked", false);
            $("#stockE").val('');
            $("#categorySelect").val('');

            // Get the product ID stored in the modal's data-id
            let id = $("#productId").attr("data-id")
            console.log("Selected Product ID for Edit: ", id);  // Verify ID

            if (!id) {
                alert("Invalid Product ID!");
                return;
            }

            $.get('/ProductList/GetProduct', { itemId: id, _t: new Date().getTime() }, function (data) {
                console.log("Product Data: ", data);

                if (!data) {
                    alert("Product data could not be retrieved!");
                    return;
                }

                // Populate edit modal with the product data
                $("#explanationE").val(data.explanation);
                $("#descriptionE").val(data.description);
                $("#widthE").val(data.width);
                $("#heightE").val(data.height);
                $("#priceE").val(data.price);
                $("#breakibilityE").prop("checked", data.breakibility);
                $("#stockE").val(data.stock);
                $("#categorySelect").val(data.categoryId);

                // Show the modal
                $("#editModal").modal("show");
            }).fail(function (jqXHR, textStatus, errorThrown) {
                console.error("Error fetching product data: ", textStatus, errorThrown);
                alert("Error while fetching product data.");
            });

            // Handle product update
            $("#submitB").off("click").on("click", function () {
                const updatedProduct = {
                    id: id,
                    price: $("#priceE").val(),
                    categoryId: $("#categorySelect").val(),
                    breakibility: $("#breakibilityE").prop("checked"),
                    width: $("#widthE").val(),
                    height: $("#heightE").val(),
                    description: $("#descriptionE").val(),
                    explanation: $("#explanationE").val(),
                    stock: $("#stockE").val()
                };

                $.post("/ProductList/UpdateProduct", updatedProduct, function () {
                    alert("Product updated successfully!");
                    $("#editModal").modal("hide");
                    location.reload();
                }).fail(function () {
                    alert("Error during update.");
                });
            });

        });


    </script>


    <footer class="footer bg-light text-center py-3">
        <div class="container">
            <span class="text-muted">&copy; @DateTime.Now.Year - Customer Management System</span>
        </div>
    </footer>
</body>
</html>