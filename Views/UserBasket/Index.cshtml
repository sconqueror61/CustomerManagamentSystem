@model IEnumerable<CustomerManagementSystem.DB.User>
@{
    Layout = null;
    ViewData["Title"] = "Shopping Basket";
}

<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="utf-8" />
    <title>@ViewData["Title"] - CMS</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="~/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/CustomerManagementSystem.styles.css" asp-append-version="true" />
    <link href="~/font-awesome/all.min.css" rel="stylesheet" />

    <style>
        body {
            background-color: #f8f9fa;
        }

        .card-img-top {
            height: 220px;
            object-fit: cover;
        }

        .card-body h5 {
            font-weight: bold;
            font-size: 1.1rem;
        }

        .filter-btn {
            min-width: 100px;
        }

        #productContainer .card {
            transition: transform 0.2s ease;
        }

        #productContainer .card:hover {
            transform: scale(1.02);
        }

        .product-image {
            width: 100%; /* Resmin genişliğini tamamen kapsayıcıya uydurur */
            height: 200px; /* Yüksekliği sabitler */
            object-fit: contain; /* Resmin doğru şekilde sığmasını sağlar */
            object-position: center; /* Resmin merkezlenmesini sağlar */
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
        <div class="container-fluid px-4 d-flex justify-content-between align-items-center">

            <!-- Sol: Logo ve Menü -->
            <div class="d-flex align-items-center gap-4">
                <a class="navbar-brand fw-bold text-white" href="#">CMS</a>
                <ul class="navbar-nav flex-row gap-3">
                    <li class="nav-item">
                        <a class="nav-link text-white" asp-area="" asp-controller="CustomerHome" asp-action="Index">
                            <i class="fa-solid fa-house"></i> Home
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-danger" asp-area="" asp-controller="ProductList" asp-action="CustomerIndex">
                            <i class="fa-solid fa-bolt-lightning"></i> Products
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-warning" asp-area="" asp-controller="UserBasket" asp-action="Index">
                            <i class="fa-solid fa-cart-shopping"></i> Shopping Basket
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-info" asp-area="" asp-controller="Order" asp-action="Index">
                            <i class="fa-solid fa-list-check"></i> Orders
                        </a>
                    </li>
                </ul>
            </div>

            <!-- Orta: Search -->
            <form class="d-flex mx-auto w-100 justify-content-center" style="max-width: 400px;">
                <input class="form-control me-2" type="search" placeholder="Search..." aria-label="Search"
                       style="height: 34px; font-size: 14px;">
                <button class="btn btn-success" type="submit" style="height: 34px;">
                    <i class="fa-solid fa-magnifying-glass"></i>
                </button>
            </form>

            <!-- Sağ: LogOut -->
            <div class="text-end">
                <a class="btn btn-danger d-flex align-items-center gap-2" asp-area="" asp-controller="Starting" asp-action="LogOut"
                   style="height: 34px; font-size: 14px;">
                    <i class="fa-solid fa-right-from-bracket"></i> LogOut
                </a>
            </div>
        </div>
    </nav>

    <!-- Ana İçerik: Kategori + Sıralama + Ürünler -->
    <div class="container mt-4">

        <!-- Kategori, Sıralama ve Toplam Fiyat (Tek Satır) -->
        <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-2">

            <!-- Sol: Kategori Butonları -->
            <div id="buttonContainer" class="d-flex flex-wrap gap-2 align-items-center">
                <!-- Dinamik kategori butonları buraya gelir -->
            </div>

            <!-- Sağ: Sıralama ve Toplam -->
            <div class="d-flex flex-wrap align-items-center gap-3">

                <!-- Sıralama Butonları -->
                <div class="d-flex gap-2 align-items-center">
                    <button class="btn btn-outline-secondary d-flex align-items-center gap-1" id="highFilter">
                        <i class="fa-solid fa-arrow-up"></i> <span>Up $</span>
                    </button>
                    <button class="btn btn-outline-secondary d-flex align-items-center gap-1" id="lowFilter">
                        <i class="fa-solid fa-arrow-down"></i> <span>Down $</span>
                    </button>
                </div>

                <!-- Sepeti Onayla Butonu -->
                <button id="confirmBasketBtn" class="btn btn-success d-flex align-items-center gap-2">
                    <i class="fa-solid fa-cart-arrow-down"></i> <span>Confirm Basket</span>
                </button>

                <!-- Toplam Fiyat -->
                <div id="totalPriceContainer" class="fw-bold fs-5 text-success text-nowrap">
                    <!-- JavaScript ile doldurulacak -->
                </div>

            </div>

        </div>

        <!-- Ürünler -->
        <div id="productContainer" class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-4">
            <!-- Ürün kartları burada gösterilecek -->
        </div>

    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="~/bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="~/font-awesome/all.min.js"></script>

    <script>
        let selectedCategoryId = 0;
        let currentSortOrder = null;

        $(document).ready(function () {
            // Sayfa açılır açılmaz kategorileri ve ürünleri yükle
            loadCategories();

            // Sepetten ürün silme (delegated event)
            $(document).on("click", ".delete-product", function () {
                const productId = $(this).data("id");
                if (!productId) return;

                if (confirm("Sepetten bu ürünü silmek istediğinizden emin misiniz?")) {
                    $.ajax({
                        url: "/UserBasket/DeleteProductFromBasket",
                        type: "DELETE",
                        data: { productId: productId },
                        success: function (res) {
                            // Controller JSON döndürüyorsa onu da dikkate al
                            if (res && res.success === false) {
                                alert(res.message || "Silme sırasında hata oluştu.");
                                return;
                            }

                            alert("Ürün sepetten silindi.");
                            loadProducts(); // Ürünler yeniden yüklensin
                        },
                        error: function () {
                            alert("Silme sırasında hata oluştu.");
                        }
                    });
                }
            });

            // Sepeti onayla → siparişe çevir
            $("#confirmBasketBtn").click(function () {
                $.ajax({
                    url: "/Order/SubmitOrdersAndDetails",
                    type: "POST",
                    success: function (res) {
                        // Yeni action JSON döndürüyor: { success, message, ... }
                        if (!res || res.success === false) {
                            alert((res && res.message) ? res.message : "Sipariş oluşturulurken bir hata oluştu.");
                            return;
                        }

                        alert(res.message || "Siparişiniz alındı.");
                        loadProducts();
                        // Siparişler sayfasına atmak istersen:
                        // window.location.href = "/OrdersArrived/Index";
                    },
                    error: function () {
                        alert("Sipariş isteği gönderilirken bir hata oluştu.");
                    }
                });
            });

            function formatCurrency(value) {
                if (typeof value !== "number" || isNaN(value)) {
                    return "0.00 $";
                }
                return value.toFixed(2) + " $";
            }

            // Kategorileri yükle
            function loadCategories() {
                $.get("/Pcategories/GetCategoryByIds")
                    .done(function (res) {
                        const container = $("#buttonContainer").empty();

                        if (!res || !res.data || res.data.length === 0) {
                            container.text("Kategori bulunamadı.");
                            loadProducts();
                            return;
                        }

                        res.data.forEach(function (cat) {
                            const btn = $("<button>")
                                .addClass("btn filter-btn me-2 mb-2")
                                .toggleClass("btn-primary", selectedCategoryId === cat.id)
                                .toggleClass("btn-outline-primary", selectedCategoryId !== cat.id)
                                .text(cat.categories)
                                .attr("data-id", cat.id)
                                .on("click", function () {
                                    // Aynı kategoriye tekrar tıklarsa filtreyi kaldır (0)
                                    selectedCategoryId = (selectedCategoryId === cat.id) ? 0 : cat.id;

                                    $(".filter-btn")
                                        .removeClass("btn-primary")
                                        .addClass("btn-outline-primary");

                                    if (selectedCategoryId !== 0) {
                                        $(this)
                                            .removeClass("btn-outline-primary")
                                            .addClass("btn-primary");
                                    }

                                    loadProducts();
                                });

                            container.append(btn);
                        });

                        loadProducts();
                    })
                    .fail(function (err) {
                        console.error("Kategori yüklenemedi", err);
                        $("#buttonContainer").text("Kategori yüklenemedi.");
                        loadProducts();
                    });
            }

            // Sepetteki ürünleri yükle
            function loadProducts() {
                $.get("/UserBasket/GetUserBasketProducts")
                    .done(function (res) {
                        console.log(res);
                        const container = $("#productContainer").empty();

                        let total = 0;

                        // total backend'den geliyorsa onu kullan
                        if (res && typeof res.total === "number") {
                            total = res.total;
                        }

                        // Sepet boş ya da hata varsa
                        if (!res || res.success === false || !res.data || res.data.length === 0) {
                            container
                                .removeClass("row row-cols-1 row-cols-sm-2 row-cols-md-3 g-4")
                                .addClass("d-flex justify-content-center align-items-center flex-column")
                                .css("min-height", "300px")
                                .html('<div class="alert alert-warning text-center text-danger">Basket is empty</div>');

                            $("#totalPriceContainer").text("Total: " + formatCurrency(0));
                            return;
                        }

                        // Sepet doluysa grid görünümünü aç
                        container
                            .removeClass("d-flex justify-content-center align-items-center flex-column")
                            .addClass("row row-cols-1 row-cols-sm-2 row-cols-md-3 g-4")
                            .css("min-height", "");

                        let products = res.data.slice(); // kopya al

                        // Kategori filtresi
                        if (selectedCategoryId !== 0) {
                            products = products.filter(function (p) {
                                return p.categoryId === selectedCategoryId;
                            });
                        }

                        // Fiyat sıralama
                        if (currentSortOrder === "asc") {
                            products.sort(function (a, b) { return a.price - b.price; });
                        } else if (currentSortOrder === "desc") {
                            products.sort(function (a, b) { return b.price - a.price; });
                        }

                        // Backend total göndermediyse frontende hesapla
                        if (!(res && typeof res.total === "number")) {
                            total = 0;
                            products.forEach(function (p) {
                                const amount = p.amount || 0;
                                const price = p.price || 0;
                                total += amount * price;
                            });
                        }

                        $("#totalPriceContainer").text("Total: " + formatCurrency(total));

                        // Ürün kartları
                        products.forEach(function (p) {
                            const img = (p.pimages && p.pimages.length > 0)
                                ? p.pimages[0]
                                : "/images/no-image.png";

                            const subtotal = (typeof p.totalPrice === "number")
                                ? p.totalPrice
                                : (p.price || 0) * (p.amount || 0);

                            container.append(
                                '<div class="col-md-6 col-lg-4 mb-4">' +
                                    '<div class="card shadow-sm h-100 border-0">' +
                                        '<img src="' + img + '" class="card-img-top product-image" alt="' + (p.explanation || "") + '">' +
                                        '<div class="card-body text-center">' +
                                            '<h5 class="text-primary">' + (p.explanation || "") + '</h5>' +
                                            '<p class="text-muted">' + (p.description || "") + '</p>' +
                                            '<p class="fw-bold text-success">' + formatCurrency(p.price || 0) + '</p>' +
                                            '<p class="text-secondary">Quantity: ' + (p.amount || 0) + '</p>' +
                                            '<p class="fw-bold">Subtotal: ' + formatCurrency(subtotal) + '</p>' +
                                            '<button class="btn btn-sm btn-outline-danger w-100 mt-2 delete-product" data-id="' + p.id + '">' +
                                                '<i class="fa fa-trash"></i> Remove' +
                                            '</button>' +
                                        '</div>' +
                                    '</div>' +
                                '</div>'
                            );
                        });
                    })
                    .fail(function (err) {
                        console.error("Ürünler yüklenemedi", err);
                        $("#productContainer").html('<div class="alert alert-danger text-center">Ürünler yüklenemedi.</div>');
                        $("#totalPriceContainer").text("Total: " + formatCurrency(0));
                    });
            }

            // Filtre butonları (düşük / yüksek fiyat)
            $("#lowFilter").click(function () {
                currentSortOrder = (currentSortOrder !== "asc") ? "asc" : null;
                toggleSortButtons();
                loadProducts();
            });

            $("#highFilter").click(function () {
                currentSortOrder = (currentSortOrder !== "desc") ? "desc" : null;
                toggleSortButtons();
                loadProducts();
            });

            function toggleSortButtons() {
                $("#lowFilter")
                    .toggleClass("btn-secondary", currentSortOrder === "asc")
                    .toggleClass("btn-outline-secondary", currentSortOrder !== "asc");

                $("#highFilter")
                    .toggleClass("btn-secondary", currentSortOrder === "desc")
                    .toggleClass("btn-outline-secondary", currentSortOrder !== "desc");
            }
        });
    </script>


</body>
</html>
