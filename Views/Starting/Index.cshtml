<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
	<script src="~/jquery/dist/jquery.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet" />
	<link href="~/font-awesome/all.min.css" rel="stylesheet" />
    <style>
        body {
            background-color: #f4f6f9;
            font-family: 'Roboto', sans-serif;
            padding-bottom: 50px;
        }

        .dashboard-panel {
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            padding: 20px;
            min-height: 250px;
        }

        .gauge-container {
            position: relative;
            width: 100px;
            height: 100px;
            margin-left: auto;
        }

        .gauge-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.2rem;
            font-weight: bold;
            color: #5d6d7e;
        }

        .kpi-card-icon {
            font-size: 2rem;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            color: #fff;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <div class="row mb-4">

            <div class="col-xl-3 col-lg-6 mb-3" data-aos="fade-down" data-aos-delay="100">
                <div class="card h-100 p-3 shadow-sm border-0">
                    <div class="card-body">
                        <h6 class="text-muted text-uppercase mt-0">Orders (Genel Bakış)</h6>
                        <h2 class="display-5 fw-bold text-primary">38.726</h2>
                        <div class="d-flex align-items-center gap-2">
                            <span class="badge bg-success fs-6">+115%</span>
                            <span class="text-muted">Seyfullah DEMİRCİ</span>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <div class="col-xl-12 col-lg-6 mb-3" data-aos="fade-down" data-aos-delay="200">
            <div class="dashboard-panel h-100">
                <h4 class="fw-bold mb-3">Weekly Sales Performance</h4>
                <canvas id="monthlyBarChart"></canvas>
            </div>
        </div>

        <div class="row">

            <div class="col-lg-6 mb-4" data-aos="fade-up">
                <div class="dashboard-panel">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <h4 class="fw-bold">Returning Target</h4>
                        <button class="btn btn-sm btn-outline-secondary">Detay</button>
                    </div>

                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div class="d-flex gap-4">
                            <span class="d-flex align-items-center"><span class="badge" style="background-color: #55cdb9;">&nbsp;</span> Old Customer</span>
                            <span class="d-flex align-items-center"><span class="badge" style="background-color: #9294d3;">&nbsp;</span> New Customer</span>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="text-end me-3">
                                <h3 class="mb-0 fw-bold text-success"><i class="fa-solid fa-group-arrows-rotate"></i></h3>
                                <small class="text-muted">Returning Customer Range</small>
                            </div>
                            <div class="gauge-container">
                                <canvas id="gaugeChart"></canvas>
                                <div class="gauge-text text-success">78%</div>
                            </div>
                        </div>
                    </div>

                    <canvas id="returningAreaChart"></canvas>
                </div>
            </div>

            <div class="col-lg-6 mb-4" data-aos="fade-up" data-aos-delay="100">
                <div class="dashboard-panel">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <h4 class="fw-bold">Efficiency Metrics</h4>
                        <button class="btn btn-outline-secondary btn-sm">Refresh</button>
                    </div>

                    <div class="row mb-4">
                        <div class="col-3">
                            <div class="d-flex flex-column align-items-center text-center">
                                <div class="kpi-card-icon mb-2" style="background-color: #ffc107;"><i class="fa-solid fa-chart-simple"></i></div>
                                <small class="text-muted">Bounce Rate</small>
                                <h5 class="fw-bold">37.56%</h5>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="d-flex flex-column align-items-center text-center">
                                <div class="kpi-card-icon mb-2" style="background-color: #0d6efd;"><i class="fa-solid fa-square-poll-vertical"></i></div>
                                <small class="text-muted">Actual Sessions</small>
                                <h5 class="fw-bold">56.34%</h5>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="d-flex flex-column align-items-center text-center">
                                <div class="kpi-card-icon mb-2" style="background-color: #6f42c1;"><i class="fa-solid fa-wand-magic-sparkles"></i></div>
                                <small class="text-muted">New Sessions</small>
                                <h5 class="fw-bold">12.17%</h5>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="d-flex flex-column align-items-center text-center">
                                <div class="kpi-card-icon mb-2" style="background-color: #198754;"><i class="fa-solid fa-computer-mouse"></i></div>
                                <small class="text-muted">Clickthrough</small>
                                <h5 class="fw-bold">19.77%</h5>
                            </div>
                        </div>
                    </div>

                    <canvas id="efficiencyAreaChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <script>
        $(document).ready(function () {
            // AOS animasyonları
            if (typeof AOS !== "undefined") {
                AOS.init();
            }

            // --- 1. WEEKLY BAR CHART (monthlyBarChart) ---
            var weeklyLabels = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            var weeklyTotals = [0, 0, 0, 0, 0, 0, 0];

            $.ajax({
                url: "/Starting/GetCompletedOrdersDaily",
                type: "GET",
                success: function (res) {
                    if (res.success && res.data) {
                        console.log("GetCompletedOrdersDaily response:", res.data);

                        $.each(res.data, function (i, item) {
                            var dt = new Date(item.date || item.orderDate || item.Date || item.OrderDate);
                            if (isNaN(dt)) return;

                            var dayIndex = dt.getDay(); // 0=Sunday, 1=Monday...
                            var lineTotal = item.lineTotal ?? item.LineTotal ?? 0;

                            weeklyTotals[dayIndex] += lineTotal;
                        });
                    } else {
                        console.error(res.message || "GetCompletedOrdersDaily başarısız.");
                    }

                    var maxVal = Math.max.apply(null, weeklyTotals);
                    if (!isFinite(maxVal) || maxVal < 0) maxVal = 0;
                    var suggestedMax = maxVal === 0 ? 10 : Math.ceil(maxVal * 1.2);

                    var monthlyBarCtx = document.getElementById('monthlyBarChart').getContext('2d');

                    new Chart(monthlyBarCtx, {
                        type: 'bar',
                        data: {
                            labels: weeklyLabels,
                            datasets: [{
                                label: 'Weekly Income ₺',
                                data: weeklyTotals,
                                backgroundColor: 'rgba(54, 162, 235, 0.7)',
                                borderColor: 'rgb(54, 162, 235)',
                                borderWidth: 1,
                                borderRadius: 6,
                                barPercentage: 0.8,
                                categoryPercentage: 0.7
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    suggestedMax: suggestedMax,
                                    title: { display: true, text: 'Income (₺)' }
                                },
                                x: { grid: { display: false } }
                            },
                            plugins: {
                                legend: { display: false }
                            }
                        }
                    });
                },
                error: function (err) {
                    console.error("GetCompletedOrdersDaily AJAX hatası:", err);
                }
            });

            // --- 2. DÖNÜŞ HEDEFİ ALAN GRAFİĞİ + 3. ORAN HALKA GRAFİĞİ ---
            var returningCtx = document.getElementById('returningAreaChart').getContext('2d');
            var gaugeChartCtx = document.getElementById('gaugeChart').getContext('2d');

            $.ajax({
                url: '/Starting/GetReturningAndNewCustomersChartData',
                type: 'GET',
                success: function (res) {
                    if (!res.success) {
                        console.error(res.message || "GetReturningAndNewCustomersChartData verisi alınamadı.");
                        return;
                    }

                    console.log("GetReturningAndNewCustomersChartData response:", res.data);

                    var data = res.data || [];

                    // X ekseni: gün numaraları
                    var labelsTarget = data.map(function (x) { return x.day ?? x.Day; });

                    // Y ekseni: veri
                    var returningData = data.map(function (x) { return x.returningCustomers ?? x.ReturningCustomers; });
                    var newData = data.map(function (x) { return x.newCustomers ?? x.NewCustomers; });

                    // Line chart (Old/New customer)
                    new Chart(returningCtx, {
                        type: 'line',
                        data: {
                            labels: labelsTarget,
                            datasets: [
                                {
                                    label: 'Old Customer',
                                    data: returningData,
                                    borderColor: '#55cdb9',
                                    backgroundColor: 'rgba(85, 205, 185, 0.3)',
                                    fill: true,
                                    tension: 0.4,
                                    pointRadius: 0
                                },
                                {
                                    label: 'New Customer',
                                    data: newData,
                                    borderColor: '#9294d3',
                                    backgroundColor: 'rgba(146, 148, 211, 0.3)',
                                    fill: true,
                                    tension: 0.4,
                                    pointRadius: 0
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            plugins: { legend: { display: false } },
                            scales: {
                                y: {
                                    display: false,
                                    beginAtZero: true
                                },
                                x: {
                                    grid: { display: false },
                                    ticks: {
                                        autoSkip: false
                                    }
                                }
                            }
                        }
                    });

                    // ---- Gauge oran hesaplama ----
                    var totalReturning = 0;
                    var totalNew = 0;

                    data.forEach(function (x) {
                        totalReturning += x.returningCustomers ?? x.ReturningCustomers ?? 0;
                        totalNew += x.newCustomers ?? x.NewCustomers ?? 0;
                    });

                    var total = totalReturning + totalNew;
                    var returningPercent = 0;

                    if (total > 0) {
                        returningPercent = (totalReturning / total) * 100;
                    }

                    returningPercent = Math.round(returningPercent);
                    var remainingPercent = 100 - returningPercent;

                    // Gauge chart
                    new Chart(gaugeChartCtx, {
                        type: 'doughnut',
                        data: {
                            datasets: [{
                                data: [returningPercent, remainingPercent],
                                backgroundColor: ['#55cdb9', '#e9ecef'],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            cutout: '80%',
                            rotation: 270,
                            circumference: 180,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: function () {
                                            return 'Returning Customers: ' + returningPercent + '%';
                                        }
                                    }
                                }
                            }
                        }
                    });

                    // Ortadaki yazıyı da dinamik güncelle (78% yerine gerçek değer)
                    $('.gauge-text').text(returningPercent + '%');
                },
                error: function (err) {
                    console.error("GetReturningAndNewCustomersChartData AJAX hatası:", err);
                }
            });

            // --- 4. VERİMLİLİK METRİKLERİ GRAFİĞİ (efficiencyAreaChart) ---
            var efficiencyLabels = ['2am', '3am', '5am', '6am', '7am', '8am', '9am', '1pm', '2pm', '3pm', '4pm'];
            var efficiencyAreaChartCtx = document.getElementById('efficiencyAreaChart').getContext('2d');

            new Chart(efficiencyAreaChartCtx, {
                type: 'line',
                data: {
                    labels: efficiencyLabels,
                    datasets: [
                        {
                            label: 'Sessions',
                            data: [50000, 60000, 80000, 120000, 160000, 200000, 220000, 180000, 230000, 200000, 100000],
                            borderColor: '#36a2eb',
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 2,
                            pointBackgroundColor: '#36a2eb',
                            stack: 'stack1'
                        },
                        {
                            label: 'New Sessions',
                            data: [30000, 40000, 50000, 80000, 100000, 150000, 180000, 150000, 190000, 160000, 80000],
                            borderColor: '#9294d3',
                            backgroundColor: 'rgba(146, 148, 211, 0.3)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 2,
                            pointBackgroundColor: '#9294d3',
                            stack: 'stack1'
                        },
                        {
                            label: 'Bounce Rate',
                            data: [10000, 20000, 30000, 40000, 50000, 60000, 70000, 80000, 90000, 100000, 150000],
                            borderColor: '#fcc750',
                            backgroundColor: 'rgba(252, 199, 80, 0.4)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 2,
                            pointBackgroundColor: '#fcc750',
                            stack: 'stack1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        y: {
                            beginAtZero: true,
                            stacked: true,
                            max: 300000,
                            ticks: {
                                callback: function (value) {
                                    return value / 1000 + 'K';
                                }
                            }
                        },
                        x: { grid: { display: false } }
                    }
                }
            });
        });
    </script>

</body>
</html>