<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<script src="~/jquery/dist/jquery.min.js"></script>
	<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
	<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
	<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
	<link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet" />
	<link href="~/font-awesome/all.min.css" rel="stylesheet" />
	<style>
		body {
			background-color: #f4f6f9;
			font-family: 'Roboto', sans-serif;
			padding-bottom: 50px;
		}

		.dashboard-panel {
			background-color: #fff;
			border-radius: 12px;
			box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
			padding: 20px;
			min-height: 250px;
		}

		.gauge-container {
			position: relative;
			width: 100px;
			height: 100px;
			margin-left: auto;
		}

		.gauge-text {
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			font-size: 1.2rem;
			font-weight: bold;
			color: #5d6d7e;
		}

		.kpi-card-icon {
			font-size: 2rem;
			width: 50px;
			height: 50px;
			display: flex;
			align-items: center;
			justify-content: center;
			border-radius: 8px;
			color: #fff;
		}
	</style>
</head>
<body>
	<div class="container-fluid mt-4">
		<div class="row mb-4">

			<div class="col-xl-3 col-lg-6 mb-3" data-aos="fade-down" data-aos-delay="100">
				<div class="card h-100 p-3 shadow-sm border-0">
					<div class="card-body">
						<h6 class="text-muted text-uppercase mt-0">Orders (Genel Bakış)</h6>
						<h2 class="display-5 fw-bold text-primary">38.726</h2>
						<div class="d-flex align-items-center gap-2">
							<span class="badge bg-success fs-6">+115%</span>
							<span class="text-muted">Seyfullah DEMİRCİ</span>
						</div>
					</div>
				</div>
			</div>

		</div>

		<div class="col-xl-12 col-lg-6 mb-3" data-aos="fade-down" data-aos-delay="200">
			<div class="dashboard-panel h-100">
				<h4 class="fw-bold mb-3">Weekly Sales Performance</h4>
				<canvas id="monthlyBarChart"></canvas>
			</div>
		</div>

		<div class="row">

			<div class="col-lg-6 mb-4" data-aos="fade-up">
				<div class="dashboard-panel">
					<div class="d-flex justify-content-between align-items-start mb-3">
						<h4 class="fw-bold">Returning Target</h4>
						<button class="btn btn-sm btn-outline-secondary">Detay</button>
					</div>

					<div class="d-flex justify-content-between align-items-center mb-4">
						<div class="d-flex gap-4">
							<span class="d-flex align-items-center"><span class="badge" style="background-color: #55cdb9;">&nbsp;</span> Old Customer</span>
							<span class="d-flex align-items-center"><span class="badge" style="background-color: #9294d3;">&nbsp;</span> New Customer</span>
						</div>
						<div class="d-flex align-items-center">
							<div class="text-end me-3">
								<h3 class="mb-0 fw-bold text-success"><i class="fa-solid fa-group-arrows-rotate"></i></h3>
								<small class="text-muted">Returning Customer Range</small>
							</div>
							<div class="gauge-container">
								<canvas id="gaugeChart"></canvas>
								<div class="gauge-text text-success" id="returningGaugeText">0%</div>
							</div>
						</div>
					</div>

					<canvas id="returningAreaChart"></canvas>
				</div>
			</div>

			<div class="col-lg-6 mb-4" data-aos="fade-up" data-aos-delay="100">
				<div class="dashboard-panel">
					<div class="d-flex justify-content-between align-items-start mb-3">
						<h4 class="fw-bold">Efficiency Metrics</h4>
						<button class="btn btn-outline-secondary btn-sm" id="efficiencyRefreshBtn">Refresh</button>
					</div>

					<div class="row mb-4">
						<div class="col-3">
							<div class="d-flex flex-column align-items-center text-center">
								<div class="kpi-card-icon mb-2" style="background-color: #ffc107;"><i class="fa-solid fa-chart-simple"></i></div>
								<small class="text-muted">Bounce Rate</small>
								<h5 class="fw-bold" id="bounceRateValue">--%</h5>
							</div>
						</div>
						<div class="col-3">
							<div class="d-flex flex-column align-items-center text-center">
								<div class="kpi-card-icon mb-2" style="background-color: #0d6efd;"><i class="fa-solid fa-square-poll-vertical"></i></div>
								<small class="text-muted">Actual Sessions</small>
								<h5 class="fw-bold" id="actualSessionsValue">--%</h5>
							</div>
						</div>
						<div class="col-3">
							<div class="d-flex flex-column align-items-center text-center">
								<div class="kpi-card-icon mb-2" style="background-color: #6f42c1;"><i class="fa-solid fa-wand-magic-sparkles"></i></div>
								<small class="text-muted">New Sessions</small>
								<h5 class="fw-bold" id="newSessionsValue">--%</h5>
							</div>
						</div>
						<div class="col-3">
							<div class="d-flex flex-column align-items-center text-center">
								<div class="kpi-card-icon mb-2" style="background-color: #198754;"><i class="fa-solid fa-computer-mouse"></i></div>
								<small class="text-muted">Clickthrough</small>
								<h5 class="fw-bold" id="clickthroughValue">--%</h5>
							</div>
						</div>
					</div>

					<canvas id="efficiencyAreaChart"></canvas>
				</div>
			</div>
		</div>
	</div>
	<script>
		// Global Chart nesnelerini tanımla
		var returningAreaChart;
		var gaugeChart;
		var efficiencyAreaChart;
		var monthlyBarChart; // Bu zaten yukarıda tanımlanmış, ama burada global yapalım.

		$(document).ready(function () {
			// AOS animasyonları
			if (typeof AOS !== "undefined") {
				AOS.init();
			}

			// --- 1. WEEKLY BAR CHART (monthlyBarChart) ---
			function loadMonthlyBarChart() {
				var weeklyLabels = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
				var weeklyTotals = [0, 0, 0, 0, 0, 0, 0];

				$.ajax({
					url: "/Starting/GetCompletedOrdersDaily",
					type: "GET",
					success: function (res) {
						if (res.success && res.data) {
							console.log("GetCompletedOrdersDaily response:", res.data);

							$.each(res.data, function (i, item) {
								// Sunucu tarafından gelen tarih alanlarını kontrol et
								var dateSource = item.date || item.orderDate || item.Date || item.OrderDate;
								var dt = dateSource ? new Date(dateSource) : null;
								if (!dt || isNaN(dt.getTime())) return;

								var dayIndex = dt.getDay(); // 0=Sunday, 1=Monday...
								var lineTotal = item.lineTotal ?? item.LineTotal ?? 0;

								// LineTotal'ın sayı olduğundan emin ol
								if (typeof lineTotal === 'number' && isFinite(lineTotal)) {
									weeklyTotals[dayIndex] += lineTotal;
								}
							});
						} else {
							console.error(res.message || "GetCompletedOrdersDaily başarısız.");
						}

						var maxVal = Math.max(...weeklyTotals);
						var suggestedMax = maxVal === 0 ? 10 : Math.ceil(maxVal * 1.2);

						var monthlyBarCtx = document.getElementById('monthlyBarChart')?.getContext('2d');
						if (!monthlyBarCtx) return;

						if (monthlyBarChart) {
							monthlyBarChart.destroy();
						}

						monthlyBarChart = new Chart(monthlyBarCtx, {
							type: 'bar',
							data: {
								labels: weeklyLabels,
								datasets: [{
									label: 'Weekly Income ₺',
									data: weeklyTotals,
									backgroundColor: 'rgba(54, 162, 235, 0.7)',
									borderColor: 'rgb(54, 162, 235)',
									borderWidth: 1,
									borderRadius: 6,
									barPercentage: 0.8,
									categoryPercentage: 0.7
								}]
							},
							options: {
								responsive: true,
								scales: {
									y: {
										beginAtZero: true,
										suggestedMax: suggestedMax,
										title: { display: true, text: 'Income (₺)' }
									},
									x: { grid: { display: false } }
								},
								plugins: {
									legend: { display: false }
								}
							}
						});
					},
					error: function (err) {
						console.error("GetCompletedOrdersDaily AJAX hatası:", err);
					}
				});
			}

			// --- 2. DÖNÜŞ HEDEFİ ALAN GRAFİĞİ + 3. ORAN HALKA GRAFİĞİ ---
			function loadReturningTargetCharts() {
				var returningCtx = document.getElementById('returningAreaChart')?.getContext('2d');
				var gaugeChartCtx = document.getElementById('gaugeChart')?.getContext('2d');

				if (!returningCtx || !gaugeChartCtx) return;

				$.ajax({
					url: '/Starting/GetReturningAndNewCustomersChartData',
					type: 'GET',
					success: function (res) {
						if (!res.success || !res.data) {
							console.error(res.message || "GetReturningAndNewCustomersChartData verisi alınamadı.");
							return;
						}

						console.log("GetReturningAndNewCustomersChartData response:", res);

						var data = res.data || [];

						// X ekseni: gün numaraları
						var labelsTarget = data.map(function (x) { return x.Day ?? x.day; });

						// Y ekseni: veri
						var returningData = data.map(function (x) { return x.ReturningCustomers ?? x.returningCustomers; });
						var newData = data.map(function (x) { return x.NewCustomers ?? x.newCustomers; });

						// Gauge oranı (C# tarafından hesaplanmış değer kullanılır)
						var returningPercent = Math.round(res.returningPercent ?? 0);
						var remainingPercent = 100 - returningPercent;

						// Eski grafik varsa yok et
						if (returningAreaChart) returningAreaChart.destroy();
						if (gaugeChart) gaugeChart.destroy();

						// Line chart (Old/New customer)
						returningAreaChart = new Chart(returningCtx, {
							type: 'line',
							data: {
								labels: labelsTarget,
								datasets: [
									{
										label: 'Old Customer',
										data: returningData,
										borderColor: '#55cdb9',
										backgroundColor: 'rgba(85, 205, 185, 0.3)',
										fill: true,
										tension: 0.4,
										pointRadius: 0
									},
									{
										label: 'New Customer',
										data: newData,
										borderColor: '#9294d3',
										backgroundColor: 'rgba(146, 148, 211, 0.3)',
										fill: true,
										tension: 0.4,
										pointRadius: 0
									}
								]
							},
							options: {
								responsive: true,
								plugins: { legend: { display: false } },
								scales: {
									y: {
										display: true, // Y eksenini gösterelim
										beginAtZero: true
									},
									x: {
										grid: { display: false },
										ticks: {
											autoSkip: false
										}
									}
								}
							}
						});

						// Gauge chart
						gaugeChart = new Chart(gaugeChartCtx, {
							type: 'doughnut',
							data: {
								datasets: [{
									data: [returningPercent, remainingPercent],
									backgroundColor: ['#55cdb9', '#e9ecef'],
									borderWidth: 0
								}]
							},
							options: {
								responsive: true,
								maintainAspectRatio: false,
								cutout: '80%',
								rotation: 270,
								circumference: 180,
								plugins: {
									legend: { display: false },
									tooltip: {
										callbacks: {
											label: function (context) {
												return 'Returning Customers: ' + returningPercent + '%';
											}
										}
									}
								}
							}
						});

						// Ortadaki yazıyı dinamik güncelle
						$('#returningGaugeText').text(returningPercent + '%');
					},
					error: function (err) {
						console.error("GetReturningAndNewCustomersChartData AJAX hatası:", err);
					}
				});
			}


			// --- 4. VERİMLİLİK METRİKLERİ GRAFİĞİ (efficiencyAreaChart) ---
			var efficiencyCanvas = document.getElementById('efficiencyAreaChart');

			if (efficiencyCanvas) {
				var efficiencyAreaChartCtx = efficiencyCanvas.getContext('2d');

				// İlk başta boş bir grafik oluşturuluyor
				efficiencyAreaChart = new Chart(efficiencyAreaChartCtx, {
					type: 'line',
					data: {
						labels: [],
						datasets: [
							{
								label: 'Actual Sessions', // Başlık düzeltildi
								data: [],
								borderColor: '#0d6efd', // Mavi
								backgroundColor: 'rgba(13, 110, 253, 0.2)',
								fill: true,
								tension: 0.4,
								pointRadius: 2,
								pointBackgroundColor: '#0d6efd',
							},
							{
								label: 'New Sessions',
								data: [],
								borderColor: '#6f42c1', // Mor
								backgroundColor: 'rgba(111, 66, 193, 0.2)',
								fill: true,
								tension: 0.4,
								pointRadius: 2,
								pointBackgroundColor: '#6f42c1',
							},
							{
								label: 'Bounce Rate',
								data: [],
								borderColor: '#ffc107', // Sarı
								backgroundColor: 'rgba(255, 193, 7, 0.2)',
								fill: true,
								tension: 0.4,
								pointRadius: 2,
								pointBackgroundColor: '#ffc107',
							},
							// Clickthrough Rate eklenmedi (çok kalabalık olmaması için). İstenirse eklenebilir.
						]
					},
					options: {
						responsive: true,
						interaction: { mode: 'index', intersect: false },
						scales: {
							y: {
								beginAtZero: true,
								stacked: false, // Yığılmış olmasın, daha net görünür
								max: 100,
								title: { display: true, text: 'Rate (%)' },
								ticks: {
									callback: function (value) {
										return value + '%';
									}
								}
							},
							x: { grid: { display: false } }
						},
						plugins: {
							legend: {
								display: true,
								position: 'bottom'
							}
						}
					}
				});
			} else {
				console.warn("efficiencyAreaChart canvas bulunamadı.");
			}

			function loadEfficiencyMetrics() {
				if (!efficiencyAreaChart) return;

				$.ajax({
					url: '/Starting/GetEfficiencyMetrics',
					type: 'GET',
					success: function (res) {
						if (!res || !res.success) {
							console.log("GetEfficiencyMetrics başarısız.");
							return;
						}

						console.log("GetEfficiencyMetrics response:", res);

						// 1. KPI Kartlarını Güncelle
						$('#bounceRateValue').text(res.bounceRate.toFixed(2) + '%');
						$('#actualSessionsValue').text(res.actualSessionsRate.toFixed(2) + '%');
						$('#newSessionsValue').text(res.newSessionsRate.toFixed(2) + '%');
						$('#clickthroughValue').text(res.clickthroughRate.toFixed(2) + '%'); // Clickthrough da güncellendi

						// 2. Grafik Verilerini Güncelle
						efficiencyAreaChart.data.labels = res.labels || [];

						// C# tarafından gelen dizileri doğrudan ata
						efficiencyAreaChart.data.datasets[0].data = res.sessionsData || []; // Actual Sessions
						efficiencyAreaChart.data.datasets[1].data = res.newSessionsData || []; // New Sessions
						efficiencyAreaChart.data.datasets[2].data = res.bounceData || []; // Bounce Rate

						// Clickthrough'u grafiğe eklemedik (çok kalabalık olmaması için), ama istersek eklenebilir.

						efficiencyAreaChart.update();
					},
					error: function (xhr, status, err) {
						console.log("AJAX Hatası (GetEfficiencyMetrics):", err);
					}
				});
			}

			// Sayfa ilk açıldığında yükle
			loadMonthlyBarChart();
			loadReturningTargetCharts();
			loadEfficiencyMetrics();

			// Refresh butonu
			$('#efficiencyRefreshBtn').on('click', function () {
				loadEfficiencyMetrics();
			});

		});
	</script>

</body>
</html>