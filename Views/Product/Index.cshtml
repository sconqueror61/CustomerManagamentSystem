@{
    ViewData["Title"] = "AddProduct";
}

<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <style>
        .image-preview {
            max-width: 100px;
            max-height: 100px;
            object-fit: cover;
            margin: 5px;
        }

        .right-preview-container {
            padding: 10px;
            color: dodgerblue;
        }

        .carousel-control-prev,
        .carousel-control-next {
            display: none;
        }


        #uploadedImages img {
            width: 100%;
            margin: 0 auto;
            display: block;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-md-8">
                <div class="card p-4 shadow-sm">

                    <div class="form-group mb-3">
                        <label for="explanation">Explanation</label>
                        <input type="text" id="explanation" class="form-control" placeholder="Explanation" />
                    </div>

                    <div class="form-group mb-3">
                        <label for="Up_document">Upload Document(s)</label>
                        <input id="Up_document" type="file" name="file" class="form-control" multiple />
                    </div>

                    <div class="form-group mb-3">
                        <label for="categorySelect">Category (Ana Kategori)</label>
                        <select class="form-control" id="categorySelect">
                            <option disabled selected value="">Select a Category</option>
                        </select>
                    </div>

                    <div class="form-group mb-3">
                        <label for="descriptionSelect">Description (Kategori Açıklaması)</label>
                        <select class="form-control" id="descriptionSelect" disabled>
                            <option disabled selected value="">Önce Ana Kategori Seçiniz</option>
                        </select>
                    </div>

                    <div class="form-check mb-3">
                        <input id="breakibility" type="radio" class="form-check-input" name="breakOption" />
                        <label class="form-check-label" for="breakibility">Breakability</label>
                    </div>

                    <div class="form-group mb-3">
                        <label for="price">Price</label>
                        <input id="price" type="text" class="form-control" placeholder="Price" />
                    </div>

                    <div class="form-group mb-3">
                        <label for="cost">Cost</label>
                        <input id="cost" type="text" class="form-control" placeholder="Cost" />
                    </div>

                    <div class="form-group mb-3">
                        <label for="stock">Stock</label>
                        <input type="text" id="stock" class="form-control" placeholder="Stock" />
                    </div>

                    <div class="form-row mb-3">
                        <div class="col">
                            <label for="width">Width</label>
                            <input id="width" type="text" class="form-control" placeholder="Width" />
                        </div>
                        <div class="col">
                            <label for="height">Height</label>
                            <input id="height" type="text" class="form-control" placeholder="Height" />
                        </div>
                    </div>

                    <button class="btn btn-success w-100" id="addCard">
                        <i class="fa-solid fa-file-arrow-up"></i> Upload
                    </button>

                </div>
            </div>

            <div class="col-md-4">
                <div class="card p-3 shadow-sm">
                    <h6 class="mb-3">Uploaded Images</h6>
                    <div id="carouselExampleFade" class="carousel slide carousel-fade" data-bs-ride="carousel" style="max-width: 100%; border: 1px solid #ccc; border-radius: 10px;">
                        <div id="uploadedImages" class="carousel-inner">
                        </div>
                        <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleFade" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Previous</span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleFade" data-bs-slide="next">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Next</span>
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script>
        $(document).ready(function () {
            var clickCount = 0;
            $("#breakibility").on("click", function () {
                clickCount++;
                if (clickCount === 2) {
                    $(this).prop("checked", false);
                    clickCount = 0;
                }
            });

            // Ana Kategorileri Yükleme (Orijinal Kod)
            $.ajax({
                url: '/Pcategories/GetCategoryByIds',
                type: 'GET',
                success: function (data) {
                    console.log("Gelen data:", data);

                    let select = $('#categorySelect');
                    select.empty().append('<option disabled selected value="">Select a Category</option>');

                    // Her bir kategoriyi select listesine ekle
                    const categories = data.data || data;
                    $.each(categories, function (index, item) {
                        console.log("Item:", item);
                        select.append(`<option value="${item.id}">${item.categories}</option>`);
                    });
                },
                error: function () {
                    alert('Kategoriler yüklenemedi.');
                }
            });

            // Yeni Fonksiyon: Kategori seçimi değiştiğinde Açıklamaları Yükle
            $('#categorySelect').on('change', function () {
                const categoryId = $(this).val();
                const descriptionSelect = $('#descriptionSelect');

                descriptionSelect.empty().prop('disabled', true).append('<option disabled selected value="">Açıklamalar Yükleniyor...</option>');

                if (categoryId) {
                    descriptionSelect.prop('disabled', false);

                    $.ajax({
                        url: '/Product/GetCategoryDescriptions', // Yeni Controller metodu
                        type: 'GET',
                        data: { categoryId: categoryId },
                        success: function (response) {
                            descriptionSelect.empty().append('<option disabled selected value="">Açıklama Seçiniz</option>');

                            if (response.success && response.descriptions && response.descriptions.length > 0) {
                                $.each(response.descriptions, function (index, item) {
                                    // Option Value olarak Pcategory'nin ID'si (CategoryDesc ID) kullanılacak
                                    descriptionSelect.append(`<option value="${item.id}">${item.categoryDesc}</option>`);
                                });
                            } else {
                                descriptionSelect.append('<option disabled>Bu kategoriye ait açıklama bulunamadı.</option>');
                                descriptionSelect.prop('disabled', true);
                            }
                        },
                        error: function () {
                            descriptionSelect.empty().append('<option disabled>Açıklamalar yüklenirken hata oluştu.</option>');
                            descriptionSelect.prop('disabled', true);
                        }
                    });
                } else {
                    descriptionSelect.prop('disabled', true).empty().append('<option disabled selected value="">Önce Ana Kategori Seçiniz</option>');
                }
            });


            $("#Up_document").on('change', function () {
                var image_holder = $('#uploadedImages');
                image_holder.empty();

                var files = $(this)[0].files;

                if (typeof (FileReader) !== "undefined") {
                    if (files.length > 0) {
                        // Okları göster
                        $(".carousel-control-prev, .carousel-control-next").show();

                        for (let i = 0; i < files.length; i++) {
                            let file = files[i];
                            let reader = new FileReader();

                            reader.onload = function (e) {
                                const isActive = i === 0 ? 'active' : '';
                                const $carouselItem = $(`
                                    <div class="carousel-item ${isActive}">
                                        <img src="${e.target.result}" class="d-block w-100 rounded" alt="...">
                                    </div>
                                `);
                                image_holder.append($carouselItem);
                            };
                            reader.readAsDataURL(file);
                        }
                    } else {
                        // Dosya yoksa okları gizle
                        $(".carousel-control-prev, .carousel-control-next").hide();
                    }
                } else {
                    alert("Tarayıcınız FileReader'ı desteklemiyor.");
                }
            });


            // addCard Click Handler'ı güncellendi
            $("#addCard").on("click", function () {
                var formData = new FormData();
                var files = $("#Up_document")[0].files;
                if (files.length === 0) {
                    alert("Lütfen en az bir dosya seçin.");
                    return;
                }

                // Seçim kontrolleri
                var categoryId = $("#categorySelect").val();
                var categoryDescId = $("#descriptionSelect").val();

                if (!categoryId) {
                    alert("Lütfen bir Ana Kategori seçin.");
                    return;
                }
                if (!categoryDescId) {
                    alert("Lütfen bir Kategori Açıklaması seçin.");
                    return;
                }


                for (var i = 0; i < files.length; i++) {
                    formData.append("formFiles", files[i]);
                }

                // Product datasına descriptionSelect'ten gelen ID'yi atıyoruz
                var datas = {
                    explanation: $("#explanation").val(),
                    // description alanı artık CategoryDesc'in ID'si olacak
                    description: categoryDescId,
                    breakibility: $("#breakibility").prop("checked"),
                    price: $("#price").val(),
                    stock: $("#stock").val(),
                    width: $("#width").val(),
                    height: $("#height").val(),
                    cost: $("#cost").val(),
                };

                console.log(datas);

                // 1. Ürün Ekleme AJAX
                $.ajax({
                    url: "/Product/AddProduct",
                    type: "POST",
                    data: {
                        product: datas,
                        // categoryid parametresine Ana Kategori ID'sini gönderiyoruz
                        categoryid: categoryId
                    },
                    success: function (response) {
                        if (response.success && response.id) {

                            // 2. Resim Yükleme AJAX
                            formData.append("productId", response.id);
                            $.ajax({
                                url: "/Product/Create",
                                type: "POST",
                                data: formData,
                                processData: false,
                                contentType: false,
                                success: function (uploadResponse) {
                                    const imageContainer = $('#uploadedImages');
                                    imageContainer.empty();

                                    // Başarılı yüklemeden sonra resim önizlemesi (Orijinal kodunuzda bu kısım hatalıydı, düzeltildi)
                                    // Sunucudan gelen fileUrls listesini kullanarak gösterebiliriz:
                                    if (uploadResponse.fileUrls && uploadResponse.fileUrls.length > 0) {
                                        // Tüm resimleri carousel'e yeniden yükleme
                                        let image_holder = $('#uploadedImages').empty();
                                        $(".carousel-control-prev, .carousel-control-next").show();
                                        $.each(uploadResponse.fileUrls, function(index, url) {
                                            const isActive = index === 0 ? 'active' : '';
                                            const $carouselItem = $(`
                                                <div class="carousel-item ${isActive}">
                                                    <img src="${url}" class="d-block w-100 rounded" alt="...">
                                                </div>
                                            `);
                                            image_holder.append($carouselItem);
                                        });
                                    } else {
                                         $(".carousel-control-prev, .carousel-control-next").hide();
                                    }

                                    alert("Ürün ve Dosyalar başarıyla yüklendi!");
                                },
                                error: function (xhr) {
                                    alert("Ürün başarıyla eklendi ancak dosya yükleme sırasında hata oluştu: " + xhr.statusText);
                                }
                            });
                        } else {
                            alert("Ürün eklenirken bir hata oluştu: " + response.message);
                        }
                    },
                    error: function (xhr) {
                        alert("Ürün eklenirken bir hata oluştu.");
                    }
                });
            });
        });
    </script>

    <footer class="footer bg-light text-center py-3 mt-4">
        <div class="container">
            <span class="text-muted">&copy; @DateTime.Now.Year - Customer Management System</span>
        </div>
    </footer>
</body>
</html>